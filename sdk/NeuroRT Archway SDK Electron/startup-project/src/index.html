<!DOCTYPE html>
<html>
  <!--
  MENSIA TECHNOLOGIES CONFIDENTIAL
  ________________________________

  [2012] - [2015] Mensia Technologies SA
  Copyright, All Rights Reserved.

  NOTICE: All information contained herein is, and remains
  the property of Mensia Technologies SA.
  The intellectual and technical concepts contained
  herein are proprietary to Mensia Technologies SA
  and are covered copyright law.
  Dissemination of this information or reproduction of this material
  is strictly forbidden unless prior written permission is obtained
  from Mensia Technologies SA.
  -->
  <head>
    <style type="text/css">
      h1, button {
        text-align: center;
        font-family: sans-serif;
      }
      button {
        width: 100%;
        font-size: 2rem;
      }
    </style>
    <script type="text/javascript">
var archway = require('../../SDK/archway-node');

// Will hold the id of the Echo pipeline once it is created
var echoPipelineId = null;

var startLoop = function (stillRunning) {
  return new Promise( function (fulfill, reject) {

    var loop = function () {
      // If we are still running then call the loop again in 10ms, otherwise stop
      if (stillRunning()) {
        setTimeout(loop, 10);
      } else {
        fulfill();
      }

      // Perform a loop of the Engine, this will update buffers in Archway
      if (!archway.mainloop()) {
        reject(new Error(archway.getLastError()));
      }

      if (echoPipelineId !== null) {
        // Get the incoming values from the engine and print the first channel value
        while (archway.getPendingValueCount(echoPipelineId, 1) > 0) {
          var values = archway.getPendingValue(echoPipelineId, 1);
          console.log(values);
        }

        // Get the incoming events from the engine, this will return the trigger we sent to the pipeline
        while (archway.getPendingEventCount(echoPipelineId, 1) > 0) {
          var eventId = archway.getPendingEvent(echoPipelineId, 1);
          console.log('Event received: ' + eventId);
        }

        archway.dropPendingValues(0);
        archway.dropPendingEvents(0);
      }
    }

    loop();
  });
}

/**
  * When called, this function will initialize Archway, create an Echo pipeline and process EEG signal
  * for a few seconds. Once enough time has elapsed, the processing is stopped and Archway is uninitialized.
  *
  * Processing results are displayed in the console in the Web Inspector.
  *
  * NOTE: This example separates all necessary steps semantically.
  */
function startProcessing() {
  if (archway.isInitialized()) {
    console.error("This function should only be called when Archway is not initialized");
    return;
  }
  // Start by initializing archway
  archway.asyncInitialize('login', 'password', 'console-project-async', 'config.conf').then( function () {
    console.log('Archway initialized');

    console.log('Engine type: ', archway.getEngineType());
    // Once archway is initialized progress to the next step
    return Promise.resolve();
  }).then( function () {
    // Archway is now initialized, we can create the pipeline
    echoPipelineId = archway.createPipeline(0x0, '');
    if (echoPipelineId == 0) {
      return Promise.reject(new Error(archway.getLastError()));
    }
    return Promise.resolve();
  }).then( function () {
    console.log('Pipeline created');

    return archway.asyncStartAllAcquisitionDevices();
  }).then( function () {
    console.log('Acquisition devices started');

    // Start the Engine
    return archway.asyncStartEngine();
  }).then( function () {
    console.log('Engine started');

    // Create a function that will returns true as long as we want to continue processing
    var startDate = new Date();
    var stillRunning = function () {
      var timeElapsedSinceStart = (new Date()) - startDate;
      return timeElapsedSinceStart < 2000;
    }
    // Launch the signal processing
    return startLoop(stillRunning);
  }).then( function () {
    console.log('Processing finished');

    // Stop the Engine
    return archway.asyncStopEngine();
  }).then( function () {
    console.log('Engine stopped');

    // Clean up the pipelines, note that this is not necessary if you wish to immediately
    // uninitialize the Archway
    if (!archway.releasePipeline(echoPipelineId)) {
      return Promise.reject(new Error(archway.getLastError()));
    }

    return Promise.resolve();
  }).then( function () {
    console.log('Pipelines released');

    // Stop the acquisition devices
    return archway.asyncStopAllAcquisitionDevices();
  }).then( function () {
    console.log('Acquisition devices stopped');

    // Uninitialize Archway
    return archway.asyncUninitialize();
  }).then( function () {
    console.log('Archway uninitialized');

  }).catch( function (err) {
    // The native Error object's message property is a String, we turn it into an integer
    // as all of the Errors that come from the Archway library carry integer error codes
    var errorCode = parseInt(err.message);
    console.error(err);
    // display the error code and the associated English description
    console.error("Error [", errorCode, "] : ", archway.getErrorString(errorCode));
  });
}

function exitApplication() {
  window.close();
}

document.addEventListener('DOMContentLoaded', function(event) {
  // log the Archway version
  console.log(archway.getVersionDescription());
});
     </script>
  </head>
  <body>
    <h1>Archway Electron SDK Demo</h1>
    <button onclick="startProcessing()">Start Processing</button>
    <button onclick="exitApplication()">Exit Application</button>
  </body>
</html>
