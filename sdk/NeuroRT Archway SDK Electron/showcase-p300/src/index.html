<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <!-- Archway related method are here (same code as showcase-console, but simplified) -->
    <script type="text/javascript">
      // Get the Archway object
      var archway = require('../../SDK/archway-node');

      // Whether we are currently reading data from Archway
      var acquisitionLoopRunning = false;

      // The javascript timeout object (so we can stop the loop when necessary)
      var acquisitionLoopTimeout = null;

      // Holds the ID of the monitoring pipeline we will create in the NeuroRT Engine
      var pipelineId = null;

      // The number of channels available on the first acquisition device
      // We will use this value to correctly display incoming values
      var firstAcquisitionDeviceChannelCount = null;

      /**
        * Print the string into the div element serving as a console
        */
      function log(string) {
        var date = new Date();
        console.log("[LOG] " + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds() + " - ", string);
      }

      // Uninitialize archway if it is initialized
      // This is useful when testing the application as Electron does not reload the
      // plugins when the webpage is refreshed.

      if (archway.isStarted()) {
        archway.stopEngine();
      }
      if (archway.isAcquiring()) {
        archway.stopAllAcquisitionDevices();
      }
      if (archway.isInitialized()) {
        archway.uninitialize();
      }

      /**
       * Get the last error code that occurred in Archway
       * Get the corresponding message in English
       * Return object containing both
       */
      function getLastError(archway) {
        var errorCode = archway.getLastError();
        var errorMessage = archway.getErrorString(errorCode);
        return {
          code: errorCode,
          message: errorMessage
        }
      }

      /**
        * Get the last error code and the associated message from Archway
        * Print them into the console
        */
      function logError(error) {
        var msg = "[ERROR] CODE " + error.code + " - " + error.message;
        console.error(msg);
        alert(msg);
      }

      /**
        * Starts executing a loop which calls the archway.mainloop() every 10ms
        */
      function startAcquisitionLoop() {
        if (acquisitionLoopRunning) {
          return;
        }
        log("Starting the acquisition loop\n");

        acquisitionLoopRunning = true;

        (function acquisitionLoop() {
          acquisitionLoopTimeout = setTimeout( function () {
            if (!acquisitionLoopRunning) {
              return;
            }

            if (!archway.mainloop()) {
              logError(getLastError(archway));
              acquisitionLoopRunning = false;
              clearTimeout(acquisitionLoopTimeout);
            }

            // As long as there is data available on the 1st channel of the monitor pipeline
            while (archway.getPendingValueCount(pipelineId, 0) > 0) {

              // NOTE: the getPendingValue function can throw error if the Archway is not started, initialized etc.
              try {
                var values = archway.getPendingValue(pipelineId, 0);
              } catch (archwayError) {
                logError(archwayError);
                break;
              }
            }

            // Drop the pending values, we don't need them anymore, or else it
            // will increase memory consumption. See the Archway doc for more
            // informations.
            archway.dropPendingValues(0);

            acquisitionLoop();
          }, 10);
        })();

      }

      function stopAcquisitionLoop() {
        log("Stopping the acquisition loop\n");
        acquisitionLoopRunning = false;
        clearTimeout(acquisitionLoopTimeout);
      }

      // ------------------------------------------------------
      // SEPARATED CALLS
      //
      // These calls use the simple, synchronous API to control the Archway
      // ------------------------------------------------------


      // Initialize Archway, this will connect to the Engine
      function initialize() {
        if (archway.initialize('login', 'password', 'showcase-p300', 'config.conf')) {
          log('Archway initialized\n');
        } else {
          logError(getLastError(archway));
        }
      }

      // Start Acquiring EEG from all configured devices
      function startDevices() {
        if (archway.startAllAcquisitionDevices()) {
          log('Acquisition devices started\n');

          // Save the number of channels of the first acquisition device, we will need this
          // to display the incoming values correctly
          firstAcquisitionDeviceChannelCount = archway.getAcquisitionDeviceChannelCount(0);
        } else {
          logError(getLastError(archway));
        }
      }

      // Create the pipeline and start sending data from Archway to the Engine
      // Also start looping on the mainloop() call to get data
      function start() {
        // Create the pipeline
        pipelineId = archway.createPipeline(settings.pipeline, "");
        if (pipelineId != 0) {
          log('Pipeline created\n');
        } else {
          log('Failed to create the pipeline\n');
          logError(getLastError(archway));
          return;
        }

        // Start the Engine processing
        if (archway.startEngine()) {
          log('Engine started\n');

          // Start the local mainloop() loop
          startAcquisitionLoop();
        } else {
          logError(getLastError(archway));
        }
      }

      // Stop the processing loop and the Engine
      function stop() {
        if (acquisitionLoopRunning == true) {
          stopAcquisitionLoop();
        }

        // Stop the Engine
        if (archway.stopEngine()) {
          log('Engine stopped\n');
         } else {
          logError(getLastError(archway));
          return;
        }

        // Release the pipeline
        if (archway.releasePipeline(pipelineId)) {
          log('Pipeline released\n');
        } else {
          log('Failed to release the pipeline\n');
          logError(getLastError(archway));
        }

      }

      // Stop acquiring data from the EEG devices
      function stopDevices() {
        if (archway.stopAllAcquisitionDevices()) {
          log('Acquisition devices stopped\n');
        } else {
          logError(getLastError(archway));
        }
      }

      // Uninitialize Archway and disconnect from the Engine
      function uninitialize() {
        if (archway.uninitialize()) {
          log('Archway uninitialized\n');
        } else {
          logError(getLastError(archway));
        }
      }
    </script>

    <!-- P300 game related methods are here -->
    <script type="text/javascript">
      // General settings, loaded from config-p300.json once the page is loaded.
      var settings = {}, isGameRunning = false, ctx, targetCount, nonTargetCount, totalCount;

      // Starting the game the first time (it shouldn't pass there after the
      // first time)
      function startGame() {
        // If game is already running, quit the function
        if(isGameRunning) return;

        // Remove the instructions
        var instructions = document.getElementById('instructions');
        instructions.style.display = 'none';

        // Initialize variables
        targetCount = 0;
        nonTargetCount = 0;
        totalCount = settings.target.number + settings.nonTarget.number;

        // Initialize the canvas and its context
        ctx = document.getElementById('p300-game');
        ctx.width = ctx.clientWidth;
        ctx = ctx.getContext('2d');

        // Start the devices
        startDevices();

        // Start the acquisition
        start();

        // Authorize the drawing loop
        isGameRunning = true;

        // Goto the clear step
        clear();
      };

      ///////////////////////
      // Drawing functions //
      ///////////////////////

      // Prepare the target event
      function prepareTarget() {
        // Select the color of target
        ctx.fillStyle = settings.target.color;

        // Tag the pipeline with a target event OVTK_StimulationId_Target
        archway.triggerEvent(pipelineId, 1, settings.target.label);

        // Increase the target count
        targetCount++;
      }

      // Prepare the non target event
      function prepareNonTarget() {
        // Select the color of non targer
        ctx.fillStyle = settings.nonTarget.color;

        // Tag the pipeline with a non target event OVTK_StimulationId_NonTarget
        archway.triggerEvent(pipelineId, 1, settings.nonTarget.label);

        // Increase the non target count
        nonTargetCount++;
      }

      // Draw the square, given it is a target or non target event (duration :
      // settings.durationFlash)
      function draw() {
        // Draw a target square if the random generated number if between 0
        // and the total number of target to generate, and if the total target
        // count has not been reached.
        if (Math.random() * totalCount < settings.target.number && targetCount < settings.target.number) {
          prepareTarget();
          // Else draw a non target square if the total non target count has
          // not been reached
        } else if (nonTargetCount < settings.nonTarget.number){
          prepareNonTarget();
          // Else there remains only targets to draw
        } else {
          prepareTarget();
        }

        // Draw a 60x60 square in the middle of the canvas
        ctx.fillRect((ctx.canvas.width / 2) - 50, (ctx.canvas.height / 2) - 50, 100, 100);

        // Decrease the total count of (non)target to draw
        totalCount--;

        // Wait a certain time and clear the canvas
        setTimeout(clear, settings.durationFlash);
      };

      // Clear the canvas (duration : settings.delayBetweenFlash)
      function clear() {
        // Select the color of the background
        ctx.fillStyle = settings.backgroundColor;

        // Fill the canvas with a rectangle
        ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);

        // If the total count of (non)target has not been reached, go to draw a (non)target
        if(totalCount > 0 && isGameRunning) {
          // Wait 100ms and draw a circle
          setTimeout(draw, settings.delayBetweenFlash);
        }

        // If total count has been reached, stop the game
        if(totalCount <= 0) {
          // Prevent a loop
          isGameRunning = false;

          // Stop the acquisition
          stop();

          // Stop the devices
          stopDevices();

          // Uninitialize the canvas and its context
          ctx = null;

          // Play again !
          var instructions = document.getElementById('instructions');
          instructions.innerText = 'Play again ?';
          instructions.style.display = 'block';
        }
      };

      /////////////////
      // Interaction //
      /////////////////

      function play() {
        // If there is no context, it means the game has not been initialized
        if(!ctx) {
          // Start the game
          startGame();
          // Else if there is a context but the game isn't started
        } else if(!isGameRunning) {
          // Start the acquisition loop if it isn't already started
          if(!acquisitionLoopRunning) {
            startAcquisitionLoop();
          }

          // Authorize the drawing loop
          isGameRunning = true;

          // Goto the clear step
          clear();
        }
      };

      // Pause the game
      function pause() {
        // If the game isn't already paused, stop the acquisition
        if(acquisitionLoopRunning) stopAcquisitionLoop();

        // Stop the drawing loop
        isGameRunning = false;
      };

      // Actions performed once the page is loaded
      document.addEventListener("DOMContentLoaded", function(event) {
        // If the license isn't valid, end the application
        if(!archway.isLicenseValid()) {
          logError({
            'code': 'LICENSE',
            'message': 'There is no valid license for Archway'
          });
          return;
        }

        // Once the page loaded, load the configuration JSON using XHR
        // See https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest
        var xhr = new XMLHttpRequest();
        xhr.onload = function(res){
          settings = JSON.parse(res.srcElement.responseText);

          // Parse the pipelines/label value
          settings.pipeline = parseInt(settings.pipeline);
          settings.target.label = parseInt(settings.target.label);
          settings.nonTarget.label = parseInt(settings.nonTarget.label);
        };
        xhr.open('GET', './config-p300.json');
        xhr.send();

        // Initialize Archway
        initialize();
      });
    </script>

    <style type="text/css">
      html, body { height: 100%; }
      body { margin: 0px 8px; }
      #p300-game { height: 600px; width: 100%; border: black 3px solid; }
      #instructions { position: fixed; height: 400px; padding: 200px 100px 0px; font: 48px sans-serif; }
      #toolbar button { width: 24%; }
    </style>
  </head>
  <body>
    <header>
      <div id="statusbar">
        NeuroRT JavaScript Electron SDK
      </div>
    </header>

    <!-- The container of the game -->
    <main>
      <!-- Instructions -->
      <div id="instructions">Just hit the <b>play</b> button and focus on this area.</div>
      <!-- Canvas allows us to draw things -->
      <canvas id="p300-game" height="600"></canvas>
    </main>

    <!-- Availables actions with the game -->
    <aside id="actions" class="right">
      Actions :<br/>
      <button onclick="play()">Play</button>
      <button onclick="pause()">Pause</button>
    </aside>

    <footer>
      © Mensia Technologies
    </footer>

  </body>
</html>
