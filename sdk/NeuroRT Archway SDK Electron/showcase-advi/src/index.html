<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <!-- The polyfill here is mandatory until the used version of Electron isn't >= 0.32.0 -->
    <script type="text/javascript" src="array-methods-polyfill.js"></script>
    <script type="text/javascript" src="advi.min.js"></script>
    <script type="text/javascript" src="webgl-utils.js"></script>

    <!-- Archway related method are here (same code as showcase-console, but simplified) -->
    <script type="text/javascript">
      // Get the Archway object
      var archway = require('../../SDK/archway-node');

      // Whether we are currently reading data from Archway
      var acquisitionLoopRunning = false;

      // The javascript timeout object (so we can stop the loop when necessary)
      var acquisitionLoopTimeout = null;

      // Holds the ID of the monitoring pipeline we will create in the NeuroRT Engine
      var pipelineId = null;

      // The number of channels available on the first acquisition device
      // We will use this value to correctly display incoming values
      var firstAcquisitionDeviceChannelCount = null;

      /**
        * Print the string into the div element serving as a console
        */
      function log(string) {
        var date = new Date();
        console.log("[LOG] " + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds() + " - ", string);
      }

      // Uninitialize archway if it is initialized
      // This is useful when testing the application as Electron does not reload the
      // plugins when the webpage is refreshed.

      if (archway.isStarted()) {
        archway.stopEngine();
      }
      if (archway.isAcquiring()) {
        archway.stopAllAcquisitionDevices();
      }
      if (archway.isInitialized()) {
        archway.uninitialize();
      }

      /**
       * Get the last error code that occurred in Archway
       * Get the corresponding message in English
       * Return object containing both
       */
      function getLastError(archway) {
        var errorCode = archway.getLastError();
        var errorMessage = archway.getErrorString(errorCode);
        return {
          code: errorCode,
          message: errorMessage
        }
      }

      /**
        * Get the last error code and the associated message from Archway
        * Print them into the console
        */
      function logError(error) {
        var msg = "[ERROR] CODE " + error.code + " - " + error.message;
        console.error(msg);
        alert(msg);
      }

      /**
        * Starts executing a loop which calls the archway.mainloop() every 10ms
        */
      function startAcquisitionLoop() {
        if (acquisitionLoopRunning) {
          return;
        }
        log("Starting the acquisition loop\n");

        acquisitionLoopRunning = true;

        (function acquisitionLoop() {
          acquisitionLoopTimeout = setTimeout( function () {
            if (!acquisitionLoopRunning) {
              return;
            }

            if (!archway.mainloop()) {
              logError(getLastError(archway));
              acquisitionLoopRunning = false;
              clearTimeout(acquisitionLoopTimeout);
            }

            // As long as there is data available on the 1st channel of the monitor pipeline
            while (archway.getPendingValueCount(pipelineId, pipelineChannelId) > 0) {

              // NOTE: the getPendingValue function can throw error if the Archway is not started, initialized etc.
              try {
                var values = archway.getPendingValue(pipelineId, pipelineChannelId);
                advi.feed(visualizationID, values);
              } catch (archwayError) {
                logError(archwayError);
                break;
              }
            }

            // Drop the pending values, we don't need them anymore, or else it
            // will increase memory consumption. See the Archway doc for more
            // informations.
           archway.dropPendingValues(0);

            acquisitionLoop();
          }, 10);
        })();

      }

      function stopAcquisitionLoop() {
        log("Stopping the acquisition loop\n");
        acquisitionLoopRunning = false;
        clearTimeout(acquisitionLoopTimeout);
      }

      // ------------------------------------------------------
      // SEPARATED CALLS
      //
      // These calls use the simple, synchronous API to control the Archway
      // ------------------------------------------------------


      // Initialize Archway, this will connect to the Engine
      function initialize() {
        if (archway.initialize('login', 'password', 'showcase-advi', 'config.conf')) {
          log('Archway initialized\n');
        } else {
          logError(getLastError(archway));
        }
      }

      // Start Acquiring EEG from all configured devices
      function startDevices() {
        if (archway.startAllAcquisitionDevices()) {
          log('Acquisition devices started\n');

          // Save the number of channels of the first acquisition device, we will need this
          // to display the incoming values correctly
          firstAcquisitionDeviceChannelCount = archway.getAcquisitionDeviceChannelCount(0);
        } else {
          logError(getLastError(archway));
        }
      }

      // Create the pipeline and start sending data from Archway to the Engine
      // Also start looping on the mainloop() call to get data
      function start() {
        // Create the pipeline
        pipelineId = archway.createPipeline(parseInt(settings.pipeline), "");
        if (pipelineId != 0) {
          log('Pipeline created\n');
        } else {
          log('Failed to create the pipeline\n');
          logError(getLastError(archway));
          return;
        }

        // Start the Engine processing
        if (archway.startEngine()) {
          log('Engine started\n');

          // Start the local mainloop() loop
          startAcquisitionLoop();
        } else {
          logError(getLastError(archway));
        }
      }

      // Stop the processing loop and the Engine
      function stop() {
        if (acquisitionLoopRunning == true) {
          stopAcquisitionLoop();
        }

        // Stop the Engine
        if (archway.stopEngine()) {
          log('Engine stopped\n');
         } else {
          logError(getLastError(archway));
          return;
        }

        // Release the pipeline
        if (archway.releasePipeline(pipelineId)) {
          log('Pipeline released\n');
        } else {
          log('Failed to release the pipeline\n');
          logError(getLastError(archway));
        }

      }

      // Stop acquiring data from the EEG devices
      function stopDevices() {
        if (archway.stopAllAcquisitionDevices()) {
          log('Acquisition devices stopped\n');
        } else {
          logError(getLastError(archway));
        }
      }

      // Uninitialize Archway and disconnect from the Engine
      function uninitialize() {
        if (archway.uninitialize()) {
          log('Archway uninitialized\n');
        } else {
          logError(getLastError(archway));
        }
      }
    </script>

    <!-- Visualization related method are here -->
    <script type="text/javascript">
      // Settings for all visualizations, they are loaded from usescases.json
      // once the page is loaded
      var settings = {}, visualizationID = null, pipelineChannelId;

      ////////////////////////////
      // VISUALIZATION HANDLING //
      ////////////////////////////

      // Add a visualization
      function addVisualization(usecase) {
        // Release the current visualization if there is one active
        if(visualizationID) releaseCurrentVisualization();

        // Bind the settings of the selected usecase
        var usecaseSettings = settings[usecase.value];
        // Specify the HTML container the visualization will be in
        usecaseSettings.container = 'viz-container';

        // Wrapper to convert string value to Advi constants
        switch(usecaseSettings.type) {
          // This is the oscilloscope (usecase #1, raw EEG)
          case 'Advi.VISU_LINES_LOOP':
            usecaseSettings.type = Advi.VISU_LINES_LOOP;
            break;
          // This is the spectrum (usecase #2)
          case 'Advi.VISU_BARS_INSTANT':
            usecaseSettings.type = Advi.VISU_BARS_INSTANT;
            break;
          // This is the topography (usecase #3, band power)
          case 'Advi.VISU_TOPOGRAPHY_2D':
            usecaseSettings.type = Advi.VISU_TOPOGRAPHY_2D;
            break;
          // This is the LORETA display (usecase #4)
          case 'Advi.VISU_LORETA':
            usecaseSettings.type = Advi.VISU_LORETA;
            break;
          // Otherwise, no visualization selected and end of the function.
          default:
            break;
        }

        // Set the new pipeline to connect to
        pipelineChannelId = usecaseSettings.channel;

        // Start the devices (here, simulator)
        startDevices();

        // Set a list of channels
        if(usecaseSettings.type !== Advi.VISU_LORETA) {
          usecaseSettings.channels = [];
          for(var i = 0; i < archway.getAcquisitionDeviceChannelCount(0); i++) {
            usecaseSettings.channels[i] = archway.getAcquisitionDeviceChannelName(0, i);
          }
        }

        // Set the frequency knowing the devices
        usecaseSettings.frequency = archway.getAcquisitionDeviceSamplingRate(0);

        // Add the visualization
        visualizationID = advi.addVisualization(usecaseSettings);
        log('Visualization for usecase #' + usecase.value[7] + ' has been initialized');

        // Play the visualization
        advi.play(visualizationID);

        // Start the device and feeding of the visualization
        start();
      };

      // Release the current visualization from the view.
      function releaseCurrentVisualization() {
        // First stop the acquisition, as the visualization will be released
        // and thus the feeding of the visualization isn't necessary anymore.
        if(acquisitionLoopRunning) stop();

        // Stop the devices (here, simulator)
        stopDevices();


        // Release the visualization, and remove it from the page.
        advi.releaseVisualization(visualizationID);

        // Re-initialize the reference ID of the visualization.
        visualizationID = null;

        log('Current visualization has been released.');
      };

      //////////////////////////
      // INTERACTION HANDLING //
      //////////////////////////

      function play() {
        if(!acquisitionLoopRunning) startAcquisitionLoop();
      };

      function pause() {
        if(acquisitionLoopRunning) stopAcquisitionLoop();
      };

      ////////////////////////////////
      // MOUSE INTERACTION HANDLING //
      ////////////////////////////////

      var listenToMouseMove = false, moveX = 0, moveY = 0;

      // Enable the listening of the mouse moves when a button is pushed
      function enableListenToMouseMove(evt) {
        listenToMouseMove = true;
      };

      // Disable the listening of the mouse moves when a button is released
      function disableListenToMouseMove(evt) {
        listenToMouseMove = false;
      };

      // Scale the data on the visualization when the user holds the right
      // button of the mouse and move it verticaly.
      function updateScaleRatio(evt) {
        // The value 2 is the right button
        // (see https://developer.mozilla.org/en-US/docs/Web/API/MouseEvent/button)
        if(listenToMouseMove && evt.button == 2) {

          // Going from top to bottom
          if (evt.pageY < moveY) {
            advi.scaleBy(visualizationID, 1.05);
          }

          // Going from bottom to top
          if (evt.pageY > moveY) {
            advi.scaleBy(visualizationID, 1/1.05);
          }
          // Update the previous Y position
          moveY = evt.pageY;
        }
      };

      // Rotate the LORETA visualization when the user holds the left button
      // of the mouse and move it in the X and Y direction.
      function updateRotation(evt) {
        // The value 0 is the left button
        // (see https://developer.mozilla.org/en-US/docs/Web/API/MouseEvent/button)
        if(listenToMouseMove && evt.button == 0) {

          // Rotating X
          if(evt.pageX < moveX) {
            advi.rotateBy(visualizationID, 0, -0.05);
          }

          if(evt.pageX > moveX) {
            advi.rotateBy(visualizationID, 0, 0.05);
          }

          moveX = evt.pageX;

          // Rotating Y
          if(evt.pageY < moveY) {
            advi.rotateBy(visualizationID, -0.05, 0);
          }

          if(evt.pageY > moveY) {
            advi.rotateBy(visualizationID, 0.05, 0);
          }

          moveY = evt.pageY;
        }
      };

      // Zoom in the LORETA visualization when the user holds the middle
      // button of the mouse and move it verticaly.
      function updateZoom(evt) {
        // The value 1 is the middle button
        // (see https://developer.mozilla.org/en-US/docs/Web/API/MouseEvent/button)
        if(listenToMouseMove && evt.button == 1) {
          //going from top to bottom
          if (evt.pageY < moveY) {
            advi.zoomBy(visualizationID, 1/1.05);
          }
          //going from bottom to top
          if (evt.pageY > moveY) {
            advi.zoomBy(visualizationID, 1.05);
          }
          moveY = evt.pageY;
        }
      };

      // Actions performed once the page is loaded
      document.addEventListener("DOMContentLoaded", function(event) {
        // If the license isn't valid, end the application
        if(!archway.isLicenseValid()) {
          logError({
            'code': 'LICENSE',
            'message': 'There is no valid license for Archway'
          });
          return;
        }

        // Once the page loaded, load the configuration JSON
        var xhr = new XMLHttpRequest();
        xhr.onload = function(res){
          settings = JSON.parse(res.srcElement.responseText);
        };
        xhr.open('GET', './usecases.json');
        xhr.send();

        // Initialize Archway
        initialize();

        // Add event listeners on the container to interact on mouse moves
        // with the visualization
        document.getElementById('viz-container').addEventListener("mousedown", enableListenToMouseMove);
        document.getElementById('viz-container').addEventListener("mouseup", disableListenToMouseMove);
        document.getElementById('viz-container').addEventListener("mousemove", updateScaleRatio);
        document.getElementById('viz-container').addEventListener("mousemove", updateRotation);
        document.getElementById('viz-container').addEventListener("mousemove", updateZoom);
      });
    </script>

    <style type="text/css">
      html, body { height: 100%; }
      body { margin: 0; padding: 0px 10px; }
      #viz-container {
        width: 80%;
        height: 70%;
        background: black;
        padding: 5px;
        display: inline-block;
        margin-top: 20px;
      }
      #viz-container:hover { cursor: -webkit-grab; }
      #viz-container:active { cursor: -webkit-grabbing; }
      #toolbar button { width: 24%; }
      #actions { width: 15%; display: inline-block; position: absolute; margin: 20px; }
      #actions > ul { padding-left: 10px; }
    </style>
  </head>
  <body>
    <header>
      <div id="statusbar">
        NeuroRT JavaScript Electron SDK
     </div>
      <!-- Toolbar with buttons selecting usecases -->
      <div id="toolbar">
        Select a use case<br/>
        <button onclick="addVisualization(this)" value="usecase1">Raw EEG on oscilloscope</button>
        <button onclick="addVisualization(this)" value="usecase2">Spectrum display</button>
        <button onclick="addVisualization(this)" value="usecase3">Band power display on 2D topography (alpha band 8-12 Hz)</button>
        <button onclick="addVisualization(this)" value="usecase4">LORETA display (alpha band 8-12 Hz)</button>
      </div>
    </header>

    <!-- The container of the visualization -->
    <main id="viz-container"></main>

    <!-- Availables actions with the data and the visualization -->
    <aside id="actions" class="right">
      Actions :<br/>
      <button onclick="play()">Play</button><br/>
      <button onclick="pause()">Pause</button><br/>

      <br/>
      Interactions :
      <ul>
        <li>Right click and move to scale the data (all visualization)</li>
        <li>Middle click and move to zoom a 3D visualization</li>
        <li>Left click and move to rotate a 3D visualization</li>
      </ul>
    </aside>

    <footer>
      © Mensia Technologies
    </footer>

  </body>
</html>
